---
title: 浏览器缓存机制
---
# 一、了解下其他缓存
> DNS 缓存
> CDN 缓存
## 1.1 DNS 缓存 
什么是DNS?

全称 Domain Name System ,即域名系统。
万维网上作为域名和IP地址相互映射的一个分布式数据库，能够使用户更方便的访问互联网，而不用去记住能够被机器直接读取的IP数串。DNS协议运行在UDP协议之上，使用端口号53。


**DNS解析**
简单的说,通过域名,最终得到该域名对应的IP地址的过程叫做域名解析（或主机名解析）。

```tex
www.dnscache.com (域名)  - DNS解析 -> 11.222.33.444 (IP地址)
```

**DNS缓存**

有dns的地方,就有缓存。浏览器、操作系统、Local DNS、根域名服务器，它们都会对DNS结果做一定程度的缓存。

DNS查询过程如下:

* 首先搜索浏览器自身的DNS缓存,如果存在，则域名解析到此完成。
* 如果浏览器自身的缓存里面没有找到对应的条目，那么会尝试读取操作系统的hosts文件看是否存在对应的映射关系,如果存在，则域名解析到此完成。
* 如果本地hosts文件不存在映射关系，则查找本地DNS服务器(ISP服务器,或者自己手动设置的DNS服务器),如果存在,域名到此解析完成。
* 如果本地DNS服务器还没找到的话,它就会向根服务器发出请求,进行递归查询。

## 1.2 CDN缓存

什么是CDN?

全称 Content Delivery Network,即内容分发网络
摘录一个形象的比喻,来理解CDN是什么。
>10年前，还没有火车票代售点一说，12306.cn更是无从说起。那时候火车票还只能在火车站的售票大厅购买，而我所在的小县城并不通火车，火车票都要去市里的火车站购买，而从我家到县城再到市里，来回就是4个小时车程，简直就是浪费生命。后来就好了，小县城里出现了火车票代售点，甚至乡镇上也有了代售点，可以直接在代售点购买火车票，方便了不少，全市人民再也不用在一个点苦逼的排队买票了。

简单的理解CDN就是这些代售点(缓存服务器)的承包商,他为买票者提供了便利,帮助他们在最近的地方(最近的CDN节点)用最短的时间(最短的请求时间)买到票(拿到资源),这样去火车站售票大厅排队的人也就少了。也就减轻了售票大厅的压力(起到分流作用,减轻服务器负载压力)。


用户在浏览网站的时候，CDN会选择一个离用户最近的CDN边缘节点来响应用户的请求，这样海南移动用户的请求就不会千里迢迢跑到北京电信机房的服务器（假设源站部署在北京电信机房）上了。

**CDN缓存**

关于CDN缓存,在浏览器本地缓存失效后,浏览器会向CDN边缘节点发起请求。类似浏览器缓存,CDN边缘节点也存在着一套缓存机制。CDN边缘节点缓存策略因服务商不同而不同，但一般都会遵循http标准协议，通过http响应头中的

```html?linenums
Cache-control: max-age   //后面会提到
```
的字段来设置CDN边缘节点数据缓存时间。

当浏览器向CDN节点请求数据时，CDN节点会判断缓存数据是否过期，若缓存数据并没有过期，则直接将缓存数据返回给客户端；否则，CDN节点就会向服务器发出回源请求，从服务器拉取最新数据，更新本地缓存，并将最新数据返回给客户端。 CDN服务商一般会提供基于文件后缀、目录多个维度来指定CDN缓存时间，为用户提供更精细化的缓存管理。

**CDN 优势**
* CDN节点解决了跨运营商和跨地域访问的问题，访问延时大大降低。
* 大部分请求在CDN边缘节点完成，CDN起到了分流作用，减轻了源服务器的负载。


# 二、浏览器缓存(http缓存)
注意，我们讨论的所有关于缓存资源的问题，都仅仅针对GET请求。而对于POST, DELETE, PUT这类行为性操作通常不做任何缓存。

![浏览器请求静态资源的流程](https://user-gold-cdn.xitu.io/2017/9/25/c91480c8103aaa39fe7d000cc8f3aa59?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)


浏览器缓存的作用？
 * 加快页面打开速度
 * 降低服务器压力
 * 减少网络损耗


浏览器缓存有 **HTML Meta 标签** 控制与 **HTTP 头信息**控制两种。

## 2.1、html meta标签控制
```html?linenums
<meta http-equiv="Pragma" content="no-cache">
```

上述代码的作用是告诉浏览器当前页面不被缓存，所以每当需要请求该页面时都需要去服务器获取。

但由于仅有部分浏览器支持该标签，并且所有的缓存代理服务器均不支持，所以并未被广泛使用。

##  2.2、HTTP头信息控制

对于每次浏览器第一次HTTP请求来说，浏览器缓存中并不存在其请求资源相应的副本，这是浏览器便会向服务器发出HTTP请求来获取相应的请求结果，并根据缓存标识字段，来决定是否将请求结果作为副本存入浏览器缓存中。

HTTP 保持已缓存数据与服务器数据之间充分一致的机制称为**文档过期和服务器再验证**。而从浏览器缓存分类来看，也有将其分为**强制缓存**和**协商缓存**。

### 文档过期
当浏览器发起 HTTP 请求时，会根据浏览器缓存中的**缓存标识字段**来验证文档（资源副本）是否过期。
上述说的缓存标识字段便是 **Expires** 和 **Cache-Control**。

**Expires** 是服务器端在响应请求时用来规定资源的失效时间。

**Cache-Control**是服务器端在响应请求时用来规定资源是否需要被浏览器缓存以及缓存的有效时间等。

![](https://user-gold-cdn.xitu.io/2018/7/1/16454a13e8ae3a2c?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

Cache-Control 主要取值如下：
 * public：所有内容都将被缓存（客户端和代理服务器都可缓存）
 * private：内容只缓存到私有缓存中（仅客户端可以缓存，代理服务器不可缓存）
* no-cache：必须先与服务器确认返回的响应是否被更改，然后才能使用该响应来满足后续对同一个网址的请求。因此，如果存在合适的验证令牌（ETag），no-cache 会发起往返通信来验证缓存的响应，如果资源未被更改，可以避免下载
* no-store：所有内容都不会被缓存或 Internet 临时文件中
* must-revalidation/proxy-revalidation：如果缓存的内容失效，请求必须发送到服务器/代理以进行重新验证
* max-age=xxx：缓存的内容将在 xxx 秒后失效

这里需要注意的是，no-cache 的作用是指跳过文档过期的验证而直接进行服务器再验证，而 no-store 是指资源禁止被缓存。

### 服务器再验证

在浏览器缓存中，还保存了其它关于资源副本的描述字段，这些字段都是服务器返回信息头带过来的，如 Last-Modified 和 Etag。

![](https://user-gold-cdn.xitu.io/2018/7/1/16454a13e89396c0?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

**Last-Modified** 是服务器端在响应请求时用来说明资源的最后修改时间。与之对应的是 If-Modified-Since 字段，在服务器再验证过程中，浏览器发送的 HTTP 请求的请求头中会带上 If-Modified-Since 字段，值为该资源 Last-Modified 属性的值。
当服务器端接收到带有 If-Modified-Since 属性的请求时，则会将 If-Modified-Since 属性的值与被请求资源的最后修改时间做对比。如果相同，说明资源没有新的修改，则响应 HTTP 304，浏览器会继续使用原先保存的该资源的副本；如果最后修改时间比较新，则说明资源被修改过，则响应 HTTP 200，并且返回最新的资源。

**Etag** 是服务器端在响应请求时用来说明资源在服务器端的唯一标识。与之对应的是 If-None-Match 字段，在服务器再验证过程中，浏览器发送的 HTTP 请求的请求头中会带上 If-Modified-Since 字段，值为该资源 Etag 属性的值。

![浏览器发起 HTTP 请求时缓存机制的过程](https://user-gold-cdn.xitu.io/2018/7/1/16454a13e8cbd673?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)


##  2.3、浏览器行为引起的不同

浏览器的行为会产生怎样的请求：

* 刷新网页 => 如果缓存没有失效，浏览器会直接使用缓存；反之，则向服务器请求数据
* 手动刷新（F5） => 浏览器会认为缓存失效，在请求服务器时加上Cache-Control: max-age=0字段，然后询问服务器数据是否更新。
* 强制刷新（Ctrl + F5） => 浏览器会直接忽略缓存，在请求服务器时加上Cache-Control: no-cache字段，然后重新向服务器拉取文件。
